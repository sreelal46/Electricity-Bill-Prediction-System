{{!-- ===================================================================
  USER DASHBOARD - Main View
  Location: backend/views/user/dashboard.hbs
  Shows ML predictions and energy insights
  =================================================================== --}}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{title}} - KSEB Smart Meter</title>
  <link rel="stylesheet" href="/css/user-dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <header class="dashboard-header">
      <h1>‚ö° My Energy Dashboard</h1>
      <div class="user-info">
        <span>User ID: {{userId}}</span>
        <button onclick="refreshData()" class="btn-refresh">üîÑ Refresh</button>
      </div>
    </header>

    {{#if error}}
    <!-- Error Message -->
    <div class="alert alert-error">
      <strong>‚ö†Ô∏è Error:</strong> {{error}}
    </div>
    {{/if}}

    {{#if insights}}
    <!-- Current Status Card -->
    <div class="card status-card">
      <h2>üìä Current Status</h2>
      {{#if insights.currentAnomaly}}
        {{#if insights.currentAnomaly.is_anomaly}}
        <div class="anomaly-alert alert-{{toLowerCase insights.currentAnomaly.severity}}">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
            <h3>{{insights.currentAnomaly.message}}</h3>
            <p>Current Power: <strong>{{insights.currentAnomaly.current_power_w}}W</strong></p>
            <p>Threshold: {{insights.currentAnomaly.thresholds.single_phase_max_w}}W</p>
            <p class="severity">Severity: <span class="badge badge-{{toLowerCase insights.currentAnomaly.severity}}">{{insights.currentAnomaly.severity}}</span></p>
          </div>
        </div>
        {{else}}
        <div class="alert alert-success">
          ‚úÖ Normal consumption - Everything looks good!
        </div>
        {{/if}}
      {{/if}}
    </div>

    <!-- Weekly Prediction Card -->
    {{#if insights.weeklyPrediction}}
    <div class="card prediction-card">
      <h2>üìà 7-Day Forecast</h2>
      <div class="summary-stats">
        <div class="stat-box">
          <span class="stat-label">Total Predicted</span>
          <span class="stat-value">{{insights.weeklyPrediction.total_predicted_kwh}} kWh</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Estimated Bill</span>
          <span class="stat-value">‚Çπ{{insights.weeklyPrediction.predicted_bill_inr}}</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Daily Average</span>
          <span class="stat-value">{{insights.weeklyPrediction.current_daily_avg_kwh}} kWh</span>
        </div>
      </div>

      <!-- Daily Chart -->
      <div class="chart-container">
        <canvas id="weeklyChart"></canvas>
      </div>

      <div class="daily-breakdown">
        <h3>Daily Breakdown</h3>
        <table class="prediction-table">
          <thead>
            <tr>
              <th>Day</th>
              <th>Date</th>
              <th>Predicted kWh</th>
            </tr>
          </thead>
          <tbody>
            {{#each insights.weeklyPrediction.daily_predictions}}
            <tr>
              <td>Day {{this.day}}</td>
              <td>{{this.date}}</td>
              <td>{{this.predicted_kwh}} kWh</td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
    {{/if}}

    <!-- Monthly Forecast Card -->
    {{#if insights.monthlyForecast}}
    <div class="card forecast-card">
      <h2>üìÖ Monthly Forecast</h2>
      <div class="summary-stats">
        <div class="stat-box highlight">
          <span class="stat-label">Predicted Monthly Bill</span>
          <span class="stat-value big">‚Çπ{{insights.monthlyForecast.predicted_bill_inr}}</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Total Units</span>
          <span class="stat-value">{{insights.monthlyForecast.total_predicted_kwh}} kWh</span>
        </div>
      </div>

      <!-- Bill Breakdown -->
      <div class="bill-breakdown">
        <h3>Bill Breakdown (KSEB Tariff)</h3>
        <div class="breakdown-items">
          <div class="breakdown-item">
            <span>0-50 units @ ‚Çπ3/unit</span>
            <span>‚Çπ{{insights.monthlyForecast.bill_breakdown.0-50_units}}</span>
          </div>
          <div class="breakdown-item">
            <span>51-100 units @ ‚Çπ3.5/unit</span>
            <span>‚Çπ{{insights.monthlyForecast.bill_breakdown.51-100_units}}</span>
          </div>
          <div class="breakdown-item">
            <span>101-200 units @ ‚Çπ5/unit</span>
            <span>‚Çπ{{insights.monthlyForecast.bill_breakdown.101-200_units}}</span>
          </div>
          <div class="breakdown-item">
            <span>Above 200 units @ ‚Çπ7/unit</span>
            <span>‚Çπ{{insights.monthlyForecast.bill_breakdown.above_200_units}}</span>
          </div>
          <div class="breakdown-item">
            <span>Fixed Charges</span>
            <span>‚Çπ{{insights.monthlyForecast.bill_breakdown.fixed_charges}}</span>
          </div>
          <div class="breakdown-item total">
            <span><strong>Total Bill</strong></span>
            <span><strong>‚Çπ{{insights.monthlyForecast.predicted_bill_inr}}</strong></span>
          </div>
        </div>
      </div>

      <!-- Energy Saving Tips -->
      <div class="tips-section">
        <h3>üí° Energy Saving Tips</h3>
        <ul class="tips-list">
          {{#if (gt insights.monthlyForecast.total_predicted_kwh 300)}}
          <li>üî¥ Your consumption is high. Consider using LED bulbs and energy-efficient appliances.</li>
          {{/if}}
          {{#if (gt insights.monthlyForecast.total_predicted_kwh 200)}}
          <li>‚ö†Ô∏è You're in the highest tariff slab. Try to reduce usage to stay under 200 units.</li>
          {{/if}}
          <li>üí∞ Use heavy appliances during off-peak hours to save money.</li>
          <li>‚ùÑÔ∏è Set AC temperature to 24-25¬∞C for optimal efficiency.</li>
          <li>üí° Turn off lights and fans when not in use.</li>
        </ul>
      </div>
    </div>
    {{/if}}

    {{else}}
    <!-- Loading State -->
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading your energy insights...</p>
    </div>
    {{/if}}

    <!-- Action Buttons -->
    <div class="action-buttons">
      <a href="/user/predictions/weekly" class="btn btn-primary">View Detailed Weekly Forecast</a>
      <a href="/user/predictions/monthly" class="btn btn-primary">View Full Monthly Report</a>
      <a href="/user/anomaly-check" class="btn btn-secondary">Check Current Usage</a>
    </div>
  </div>

  <!-- JavaScript for Charts and Interactions -->
  <script>
    const userId = '{{userId}}';
    const insights = {{{json insights}}};

    // Weekly Chart
    {{#if insights.weeklyPrediction}}
    const weeklyData = {
      labels: [
        {{#each insights.weeklyPrediction.daily_predictions}}
        '{{this.date}}',
        {{/each}}
      ],
      datasets: [{
        label: 'Predicted kWh',
        data: [
          {{#each insights.weeklyPrediction.daily_predictions}}
          {{this.predicted_kwh}},
          {{/each}}
        ],
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 2,
        tension: 0.4
      }]
    };

    const weeklyChart = new Chart(document.getElementById('weeklyChart'), {
      type: 'line',
      data: weeklyData,
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          title: {
            display: true,
            text: '7-Day Energy Consumption Forecast'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Energy (kWh)'
            }
          }
        }
      }
    });
    {{/if}}

    // Refresh data function
    async function refreshData() {
      try {
        window.location.reload();
      } catch (error) {
        console.error('Refresh failed:', error);
      }
    }

    // Auto-refresh every 5 minutes
    setInterval(refreshData, 5 * 60 * 1000);

    // Helper to convert JSON for handlebars
    Handlebars.registerHelper('json', function(context) {
      return JSON.stringify(context);
    });

    Handlebars.registerHelper('toLowerCase', function(str) {
      return str.toLowerCase();
    });

    Handlebars.registerHelper('gt', function(a, b) {
      return a > b;
    });
  </script>
</body>
</html>
