<link rel="stylesheet" href="/css/user-predictions.css">

<!-- DATA HOLDER - Data attributes for JavaScript -->
<div id="forecastData" data-available-days="{{availableDays}}" data-daily='{{json predictions.daily}}'
  data-weekly='{{json predictions.weekly}}' data-monthly='{{json predictions.monthly}}' style="display: none;">
</div>

<div class="container">
  <!-- HEADER -->
  <header class="header">
    <div class="header-content">
      <h1>
        <i data-lucide="brain-circuit"></i>
        AI Forecasts
      </h1>
      <div class="header-subtitle">
        <span class="status-indicator" id="statusIndicator"></span>
        <span id="statusText">Machine learning powered predictions for energy consumption and costs</span>
      </div>
    </div>
  </header>

  {{#if noData}}
  <!-- FULL PAGE EMPTY STATE -->
  <div class="card fade-in-up">
    <div class="empty-state">
      <div class="empty-state-icon">
        <i data-lucide="brain-circuit"></i>
      </div>
      <h2>AI Predictions Not Available</h2>
      <p>{{message}}</p>

      <div class="empty-state-steps">
        <div class="empty-state-step">
          <div class="empty-state-step-number">1</div>
          <div class="empty-state-step-content">
            <h4>Connect Your Smart Meter</h4>
            <p>Ensure your smart meter is properly connected and sending data to the system.</p>
          </div>
        </div>

        <div class="empty-state-step">
          <div class="empty-state-step-number">2</div>
          <div class="empty-state-step-content">
            <h4>Wait for Data Collection</h4>
            <p>Our AI models need at least 7 days of historical data to generate accurate predictions.</p>
          </div>
        </div>

        <div class="empty-state-step">
          <div class="empty-state-step-number">3</div>
          <div class="empty-state-step-content">
            <h4>Check Back Later</h4>
            <p>Once sufficient data is collected, predictions will appear here automatically.</p>
          </div>
        </div>
      </div>

      <div class="empty-state-actions">
        <button class="empty-state-btn" onclick="location.reload()">
          <i data-lucide="refresh-cw"></i>
          Refresh Page
        </button>
        <button class="empty-state-btn secondary" onclick="window.location.href='/user/dashboard'">
          <i data-lucide="layout-dashboard"></i>
          Go to Dashboard
        </button>
        <!-- <button class="empty-state-btn secondary" onclick="window.location.href='/user/help'">
          <i data-lucide="help-circle"></i>
          Get Help
        </button> -->
      </div>
    </div>
  </div>
  {{else}}

  <!-- Model Confidence Banner -->
  <div class="alert alert-info fade-in">
    <div class="flex items-center gap-2 mb-2">
      <i data-lucide="shield-check" style="width: 20px; height: 20px;"></i>
      <h3 class="text-lg font-semibold" style="color: #4f46e5;">
        Model Confidence: <span class="text-capitalize">{{predictions.daily.prediction.confidence}}</span>
        {{#if predictions.daily.prediction.confidence}}
        {{#ifEquals predictions.daily.prediction.confidence "high"}}(95%){{/ifEquals}}
        {{#ifEquals predictions.daily.prediction.confidence "medium"}}(75%){{/ifEquals}}
        {{#ifEquals predictions.daily.prediction.confidence "low"}}(50%){{/ifEquals}}
        {{/if}}
      </h3>
    </div>
    <p style="font-size: 0.875rem; color: #4f46e5;">
      Our predictive models have analyzed <strong>{{availableDays}}</strong> days of historical data.
      {{#if predictions.daily.prediction.warning}}
      <span class="badge badge-warning mt-1" style="display: inline-block;">
        ⚠️ {{predictions.daily.prediction.warning}}
      </span>
      {{/if}}
    </p>
  </div>

  <!-- AI Prediction Cards -->
  <div class="grid grid-cols-3 mb-4">
    <!-- Tomorrow's Usage -->
    <div class="card kpi-card fade-in-up">
      <div class="kpi-label">
        <div class="icon-box" style="background: rgba(99, 102, 241, 0.1); color: var(--accent-indigo);">
          <i data-lucide="calendar-days"></i>
        </div>
        Tomorrow's Usage
      </div>
      <div class="kpi-value">
        <span>{{predictions.daily.prediction.next_day_units}}</span>
        <span class="kpi-unit">kWh</span>
      </div>
      <div class="kpi-details">
        2-Month Bill: ₹{{predictions.daily.prediction.predicted_2month_bill}}
        {{#if predictions.daily.prediction.anomaly_detected}}
        <span class="badge badge-danger ml-1">
          <i data-lucide="alert-triangle" style="width: 12px; height: 12px;"></i>
          Anomaly Detected
        </span>
        {{/if}}
      </div>
      <div class="chart-container" id="dailyChartContainer">
        <canvas id="dailyChart"></canvas>
      </div>
    </div>

    <!-- Next Week Forecast -->
    <div class="card kpi-card fade-in-up">
      <div class="kpi-label">
        <div class="icon-box" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue);">
          <i data-lucide="calendar-range"></i>
        </div>
        Next Week Forecast
      </div>
      <div class="kpi-value">
        <span>{{predictions.weekly.prediction.weekly_prediction.total_weekly_units}}</span>
        <span class="kpi-unit">kWh</span>
      </div>
      <div class="kpi-details">
        Avg Daily: {{predictions.weekly.prediction.weekly_prediction.avg_daily_units}} kWh<br>
        <span class="text-xs">
          {{predictions.weekly.prediction.weekly_prediction.start_date}} -
          {{predictions.weekly.prediction.weekly_prediction.end_date}}
        </span>
      </div>
      <div class="chart-container" id="weeklyChartContainer">
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>

    <!-- Monthly Projection -->
    <div class="card kpi-card fade-in-up">
      <div class="kpi-label">
        <div class="icon-box" style="background: rgba(16, 185, 129, 0.1); color: var(--accent-green);">
          <i data-lucide="calendar"></i>
        </div>
        Monthly Projection
      </div>
      <div class="kpi-value">
        <span>{{predictions.monthly.prediction.monthly_prediction.total_monthly_units}}</span>
        <span class="kpi-unit">kWh</span>
      </div>
      <div class="kpi-details">
        Monthly Bill: ₹{{predictions.monthly.prediction.predicted_monthly_bill}}<br>
        2-Month Bill: ₹{{predictions.monthly.prediction.predicted_2month_bill}}
      </div>
      <div class="chart-container" id="monthlyChartContainer">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Weekly Breakdown Table -->
  <div class="card fade-in-up mb-3">
    <div class="card-header">
      <h3 class="card-title" style="color: var(--accent-indigo);">
        <i data-lucide="list" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
        7-Day Detailed Forecast
      </h3>
    </div>
    <div class="table-wrapper" id="weeklyTableWrapper">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Day</th>
            <th style="text-align: right;">Predicted Units (kWh)</th>
          </tr>
        </thead>
        <tbody id="weeklyTableBody">
          {{#each predictions.weekly.prediction.weekly_prediction.predictions}}
          <tr>
            <td>{{this.date}}</td>
            <td>{{this.day_name}}</td>
            <td style="text-align: right;">
              <span class="text-mono font-semibold">{{this.predicted_units}}</span>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Monthly Weekly Summaries -->
  <div class="card fade-in-up mb-3">
    <div class="card-header">
      <h3 class="card-title" style="color: var(--accent-indigo);">
        <i data-lucide="calendar-check"
          style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
        Monthly Weekly Summaries
      </h3>
    </div>
    <div class="grid grid-cols-4" id="weeklySummariesGrid">
      {{#each predictions.monthly.prediction.monthly_prediction.weekly_summaries}}
      <div class="week-card">
        <div class="week-label">Week {{this.week}}</div>
        <div class="week-value">{{this.total_units}} kWh</div>
        <div class="week-avg">Avg: {{this.avg_daily_units}} kWh/day</div>
        <div class="week-date">{{this.start_date}} - {{this.end_date}}</div>
      </div>
      {{/each}}
    </div>
  </div>

  <!-- Bottom Two Sections -->
  <div class="grid grid-cols-2">
    <!-- Prediction Insights -->
    <div class="card fade-in-up">
      <div class="card-header">
        <h3 class="card-title" style="color: var(--accent-green);">
          <i data-lucide="sparkles"
            style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
          Prediction Insights
        </h3>
      </div>
      <div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Data analyzed: <strong>{{availableDays}} days</strong> of historical usage
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Model confidence: <strong>{{predictions.daily.prediction.confidence}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Next day prediction: <strong>{{predictions.daily.prediction.next_day_units}} kWh</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Weekly average: <strong>{{predictions.weekly.prediction.weekly_prediction.avg_daily_units}} kWh/day</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Monthly projection: <strong>{{predictions.monthly.prediction.monthly_prediction.total_monthly_units}}
              kWh</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Billing Estimates -->
    <div class="card fade-in-up">
      <div class="card-header">
        <h3 class="card-title" style="color: var(--accent-yellow);">
          <i data-lucide="indian-rupee"
            style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
          Billing Estimates
        </h3>
      </div>
      <div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted monthly bill (30 days):
            <strong>₹{{predictions.monthly.prediction.predicted_monthly_bill}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted 2-month bill (daily basis):
            <strong>₹{{predictions.daily.prediction.predicted_2month_bill}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted 2-month bill (weekly basis):
            <strong>₹{{predictions.weekly.prediction.predicted_2month_bill}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted 2-month bill (monthly basis):
            <strong>₹{{predictions.monthly.prediction.predicted_2month_bill}}</strong>
          </div>
        </div>
        {{#if predictions.daily.prediction.anomaly_detected}}
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="alert-triangle" style="color: var(--accent-red);"></i>
          </div>
          <div class="insight-text">
            <strong style="color: var(--accent-red);">⚠️ Anomaly detected in recent usage patterns</strong>
          </div>
        </div>
        {{/if}}
      </div>
    </div>
  </div>

  {{/if}}
</div>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/js/user-predictions.js"></script>