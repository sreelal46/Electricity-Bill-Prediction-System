<script src="https://unpkg.com/lucide@latest"></script>
<style>
  /* Page-specific styles */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    animation: slideDown 0.6s ease-out;
  }

  .header-content h1 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }

  .header-content h1 svg {
    width: 36px;
    height: 36px;
    color: var(--accent-purple);
  }

  .header-subtitle {
    color: var(--text-secondary);
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* KPI Cards */
  .kpi-card {
    position: relative;
    overflow: hidden;
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .kpi-card:hover::before {
    opacity: 1;
  }

  .kpi-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .kpi-value {
    font-size: 2.25rem;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    line-height: 1;
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .kpi-unit {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .kpi-details {
    font-size: 0.875rem;
    color: var(--accent-indigo);
    line-height: 1.5;
  }

  .chart-container {
    position: relative;
    height: 100px;
    margin-top: 1rem;
  }

  /* Weekly Summary Cards */
  .week-card {
    background: var(--bg-secondary);
    padding: 1.25rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    transition: all 0.2s ease;
  }

  .week-card:hover {
    background: var(--bg-card);
    border-color: var(--accent-blue);
    transform: translateY(-2px);
  }

  .week-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .week-value {
    font-size: 1.25rem;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .week-avg {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }

  .week-date {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Insights Section */
  .insight-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
  }

  .insight-item:last-child {
    border-bottom: none;
  }

  .insight-icon {
    flex-shrink: 0;
    margin-top: 0.25rem;
  }

  .insight-icon svg {
    width: 16px;
    height: 16px;
    color: var(--accent-green);
  }

  .insight-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .insight-text strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  /* Animation delays */
  .card:nth-child(1) {
    animation-delay: 0.1s;
  }

  .card:nth-child(2) {
    animation-delay: 0.2s;
  }

  .card:nth-child(3) {
    animation-delay: 0.3s;
  }

  .card:nth-child(4) {
    animation-delay: 0.4s;
  }

  .card:nth-child(5) {
    animation-delay: 0.5s;
  }

  .card:nth-child(6) {
    animation-delay: 0.6s;
  }

  .text-capitalize {
    text-transform: capitalize;
  }
</style>

<!-- DATA HOLDER - Data attributes for JavaScript -->
<div id="forecastData" data-available-days="{{availableDays}}" data-daily='{{json predictions.daily}}'
  data-weekly='{{json predictions.weekly}}' data-monthly='{{json predictions.monthly}}' style="display: none;">
</div>

<div class="container">
  <!-- HEADER -->
  <header class="header">
    <div class="header-content">
      <h1>
        <i data-lucide="brain-circuit"></i>
        AI Forecasts
      </h1>
      <div class="header-subtitle">
        <span class="status-indicator"></span>
        <span>Machine learning powered predictions for energy consumption and costs</span>
      </div>
    </div>
  </header>

  {{#if noData}}
  <div class="alert alert-warning">
    <h3>No Data Available</h3>
    <p>{{message}}</p>
  </div>
  {{else}}

  <!-- Model Confidence Banner -->
  <div class="alert alert-info fade-in">
    <div class="flex items-center gap-2 mb-2">
      <i data-lucide="shield-check" style="width: 20px; height: 20px;"></i>
      <h3 class="text-lg font-semibold" style="color: #4f46e5;">
        Model Confidence: <span class="text-capitalize">{{predictions.daily.prediction.confidence}}</span>
        {{#if predictions.daily.prediction.confidence}}
        {{#ifEquals predictions.daily.prediction.confidence "high"}}(95%){{/ifEquals}}
        {{#ifEquals predictions.daily.prediction.confidence "medium"}}(75%){{/ifEquals}}
        {{#ifEquals predictions.daily.prediction.confidence "low"}}(50%){{/ifEquals}}
        {{/if}}
      </h3>
    </div>
    <p style="font-size: 0.875rem; color: #4f46e5;">
      Our predictive models have analyzed <strong>{{availableDays}}</strong> days of historical data.
      {{#if predictions.daily.prediction.warning}}
      <span class="badge badge-warning mt-1" style="display: inline-block;">
        ‚ö†Ô∏è {{predictions.daily.prediction.warning}}
      </span>
      {{/if}}
    </p>
  </div>

  <!-- AI Prediction Cards -->
  <div class="grid grid-cols-3 mb-4">
    <!-- Tomorrow's Usage -->
    <div class="card kpi-card fade-in-up">
      <div class="kpi-label">
        <div class="icon-box" style="background: rgba(99, 102, 241, 0.1); color: var(--accent-indigo);">
          <i data-lucide="calendar-days"></i>
        </div>
        Tomorrow's Usage
      </div>
      <div class="kpi-value">
        <span>{{predictions.daily.prediction.next_day_units}}</span>
        <span class="kpi-unit">kWh</span>
      </div>
      <div class="kpi-details">
        2-Month Bill: ‚Çπ{{predictions.daily.prediction.predicted_2month_bill}}
        {{#if predictions.daily.prediction.anomaly_detected}}
        <span class="badge badge-danger ml-1">
          <i data-lucide="alert-triangle" style="width: 12px; height: 12px;"></i>
          Anomaly Detected
        </span>
        {{/if}}
      </div>
      <div class="chart-container">
        <canvas id="dailyChart"></canvas>
      </div>
    </div>

    <!-- Next Week Forecast -->
    <div class="card kpi-card fade-in-up">
      <div class="kpi-label">
        <div class="icon-box" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue);">
          <i data-lucide="calendar-range"></i>
        </div>
        Next Week Forecast
      </div>
      <div class="kpi-value">
        <span>{{predictions.weekly.prediction.weekly_prediction.total_weekly_units}}</span>
        <span class="kpi-unit">kWh</span>
      </div>
      <div class="kpi-details">
        Avg Daily: {{predictions.weekly.prediction.weekly_prediction.avg_daily_units}} kWh<br>
        <span class="text-xs">
          {{predictions.weekly.prediction.weekly_prediction.start_date}} -
          {{predictions.weekly.prediction.weekly_prediction.end_date}}
        </span>
      </div>
      <div class="chart-container">
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>

    <!-- Monthly Projection -->
    <div class="card kpi-card fade-in-up">
      <div class="kpi-label">
        <div class="icon-box" style="background: rgba(16, 185, 129, 0.1); color: var(--accent-green);">
          <i data-lucide="calendar"></i>
        </div>
        Monthly Projection
      </div>
      <div class="kpi-value">
        <span>{{predictions.monthly.prediction.monthly_prediction.total_monthly_units}}</span>
        <span class="kpi-unit">kWh</span>
      </div>
      <div class="kpi-details">
        Monthly Bill: ‚Çπ{{predictions.monthly.prediction.predicted_monthly_bill}}<br>
        2-Month Bill: ‚Çπ{{predictions.monthly.prediction.predicted_2month_bill}}
      </div>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Weekly Breakdown Table -->
  <div class="card fade-in-up mb-3">
    <div class="card-header">
      <h3 class="card-title" style="color: var(--accent-indigo);">
        <i data-lucide="list" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
        7-Day Detailed Forecast
      </h3>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Day</th>
            <th style="text-align: right;">Predicted Units (kWh)</th>
          </tr>
        </thead>
        <tbody>
          {{#each predictions.weekly.prediction.weekly_prediction.predictions}}
          <tr>
            <td>{{this.date}}</td>
            <td>{{this.day_name}}</td>
            <td style="text-align: right;">
              <span class="text-mono font-semibold">{{this.predicted_units}}</span>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Monthly Weekly Summaries -->
  <div class="card fade-in-up mb-3">
    <div class="card-header">
      <h3 class="card-title" style="color: var(--accent-indigo);">
        <i data-lucide="calendar-check"
          style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
        Monthly Weekly Summaries
      </h3>
    </div>
    <div class="grid grid-cols-4">
      {{#each predictions.monthly.prediction.monthly_prediction.weekly_summaries}}
      <div class="week-card">
        <div class="week-label">Week {{this.week}}</div>
        <div class="week-value">{{this.total_units}} kWh</div>
        <div class="week-avg">Avg: {{this.avg_daily_units}} kWh/day</div>
        <div class="week-date">{{this.start_date}} - {{this.end_date}}</div>
      </div>
      {{/each}}
    </div>
  </div>

  <!-- Bottom Two Sections -->
  <div class="grid grid-cols-2">
    <!-- Prediction Insights -->
    <div class="card fade-in-up">
      <div class="card-header">
        <h3 class="card-title" style="color: var(--accent-green);">
          <i data-lucide="sparkles"
            style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
          Prediction Insights
        </h3>
      </div>
      <div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Data analyzed: <strong>{{availableDays}} days</strong> of historical usage
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Model confidence: <strong>{{predictions.daily.prediction.confidence}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Next day prediction: <strong>{{predictions.daily.prediction.next_day_units}} kWh</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Weekly average: <strong>{{predictions.weekly.prediction.weekly_prediction.avg_daily_units}} kWh/day</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="insight-text">
            Monthly projection: <strong>{{predictions.monthly.prediction.monthly_prediction.total_monthly_units}}
              kWh</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Billing Estimates -->
    <div class="card fade-in-up">
      <div class="card-header">
        <h3 class="card-title" style="color: var(--accent-yellow);">
          <i data-lucide="indian-rupee"
            style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></i>
          Billing Estimates
        </h3>
      </div>
      <div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted monthly bill (30 days):
            <strong>‚Çπ{{predictions.monthly.prediction.predicted_monthly_bill}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted 2-month bill (daily basis):
            <strong>‚Çπ{{predictions.daily.prediction.predicted_2month_bill}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted 2-month bill (weekly basis):
            <strong>‚Çπ{{predictions.weekly.prediction.predicted_2month_bill}}</strong>
          </div>
        </div>
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="indian-rupee"></i>
          </div>
          <div class="insight-text">
            Predicted 2-month bill (monthly basis):
            <strong>‚Çπ{{predictions.monthly.prediction.predicted_2month_bill}}</strong>
          </div>
        </div>
        {{#if predictions.daily.prediction.anomaly_detected}}
        <div class="insight-item">
          <div class="insight-icon">
            <i data-lucide="alert-triangle" style="color: var(--accent-red);"></i>
          </div>
          <div class="insight-text">
            <strong style="color: var(--accent-red);">‚ö†Ô∏è Anomaly detected in recent usage patterns</strong>
          </div>
        </div>
        {{/if}}
      </div>
    </div>
  </div>

  {{/if}}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ========================================
  // PARSE DATA FROM BACKEND
  // ========================================
  const forecastDataElement = document.getElementById('forecastData');

  if (!forecastDataElement) {
    console.error('Forecast data element not found');
  }

  const availableDays = parseInt(forecastDataElement.dataset.availableDays || '0');
  const daily = JSON.parse(forecastDataElement.dataset.daily || '{}');
  const weekly = JSON.parse(forecastDataElement.dataset.weekly || '{}');
  const monthly = JSON.parse(forecastDataElement.dataset.monthly || '{}');

  console.log('üìä Forecast Data:', { availableDays, daily, weekly, monthly });

  // Check if we have valid prediction data
  if (!daily.prediction || !weekly.prediction || !monthly.prediction) {
    console.error('Missing prediction data from backend');
  } else {
    // ========================================
    // DAILY CHART (Sparkline)
    // ========================================
    const dailyValue = daily.prediction.next_day_units;
    const dailyTrend = [
      dailyValue * 0.92,
      dailyValue * 0.95,
      dailyValue * 0.90,
      dailyValue * 0.98,
      dailyValue * 0.96,
      dailyValue * 1.02,
      dailyValue
    ];

    new Chart(document.getElementById('dailyChart'), {
      type: 'line',
      data: {
        labels: Array(7).fill(''),
        datasets: [{
          data: dailyTrend,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 0,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });

    // ========================================
    // WEEKLY CHART (Sparkline)
    // ========================================
    const weeklyPredictions = weekly.prediction.weekly_prediction.predictions;
    const weeklyData = weeklyPredictions.map(p => p.predicted_units);
    const weeklyLabels = weeklyPredictions.map(p => p.day_name.substring(0, 3));

    new Chart(document.getElementById('weeklyChart'), {
      type: 'line',
      data: {
        labels: weeklyLabels,
        datasets: [{
          data: weeklyData,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: '#3b82f6',
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.98)',
            titleColor: '#0f172a',
            bodyColor: '#0f172a',
            borderColor: 'rgba(148, 163, 184, 0.3)',
            borderWidth: 1,
            padding: 8,
            displayColors: false,
            callbacks: {
              label: (context) => `${context.parsed.y.toFixed(2)} kWh`
            }
          }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });

    // ========================================
    // MONTHLY CHART (Weekly Summaries)
    // ========================================
    const weeklySummaries = monthly.prediction.monthly_prediction.weekly_summaries;
    const monthlyData = weeklySummaries.map(w => w.avg_daily_units);
    const monthlyLabels = weeklySummaries.map(w => `W${w.week}`);

    new Chart(document.getElementById('monthlyChart'), {
      type: 'line',
      data: {
        labels: monthlyLabels,
        datasets: [{
          data: monthlyData,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointBackgroundColor: '#10b981',
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.98)',
            titleColor: '#0f172a',
            bodyColor: '#0f172a',
            borderColor: 'rgba(148, 163, 184, 0.3)',
            borderWidth: 1,
            padding: 8,
            displayColors: false,
            callbacks: {
              label: (context) => `${context.parsed.y.toFixed(2)} kWh/day`
            }
          }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
  }

  // ========================================
  // INITIALIZE LUCIDE ICONS
  // ========================================
  lucide.createIcons();
</script>