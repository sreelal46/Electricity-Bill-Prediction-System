<!-- ADMIN USERS PAGE -->
<link rel="stylesheet" href="/css/admin-users.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- Toast Notification for Copy Confirmation -->
<div class="copy-toast" id="copyToast">
  <i data-lucide="check-circle"></i>
  <span>User ID copied!</span>
</div>
<!-- Toast Notifications -->
<div class="toast success-toast" id="successToast">
  <i data-lucide="check-circle"></i>
  <div class="toast-content">
    <span class="toast-title">Success!</span>
    <span class="toast-message">Installation marked as complete</span>
  </div>
</div>

<div class="toast error-toast" id="errorToast">
  <i data-lucide="x-circle"></i>
  <div class="toast-content">
    <span class="toast-title">Error!</span>
    <span class="toast-message" id="errorToastMessage">Failed to update installation status</span>
  </div>
</div>

<!-- Data holder for users status -->
<div id="usersData" data-has-users="{{#if users}}true{{else}}false{{/if}}"
  data-users-count="{{#if users}}{{users.length}}{{else}}0{{/if}}" style="display: none;">
</div>

<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <a href="/admin/dashboard" class="back-link">
        <i data-lucide="arrow-left"></i>
        <span>Back to Dashboard</span>
      </a>
      <h1>
        <i data-lucide="users"></i>
        User Management
      </h1>
      <p class="header-subtitle">Manage and monitor all registered users</p>
    </div>

    <a href="/admin/registration" class="new-registration-btn outline">
      <i data-lucide="user-plus"></i>
      <span>New Registration</span>
    </a>
    <div class="header-stats">
      <div class="stat-pill">
        <span class="stat-value" id="usersCount">{{#if users}}{{users.length}}{{else}}0{{/if}}</span>
        <span class="stat-label">Total Users</span>
      </div>
    </div>
  </div>

  {{#if users}}
  {{#if (gt users.length 0)}}
  <!-- Users Grid -->
  <div class="users-grid">
    {{#each users}}
    <div class="user-card">
      <!-- Card Header -->
      <div class="user-header">
        <div class="user-avatar-wrapper">
          <div class="user-avatar">
            {{#if user_initials}}
            {{user_initials}}
            {{else if name}}
            {{substring name 0 1}}
            {{else}}
            U
            {{/if}}
          </div>
          <div class="user-info">
            <h3 class="user-name">{{#if name}}{{name}}{{else}}Unknown User{{/if}}</h3>
            <p class="user-id">ID: <br>{{#if id}}{{id}}{{else}}N/A{{/if}}</p>
          </div>
        </div>
        <!-- Updated Status Badge as Copy Button -->
        {{#if id}}
        <button class="copy-id-btn" data-user-id="{{id}}" onclick="copyUserId(this)" title="Click to copy User ID">
          <i data-lucide="copy"></i>
          <span class="badge-text">Copy ID</span>
        </button>
        {{/if}}
      </div>

      <!-- Card Body -->
      <div class="user-details2">
        <div class="detail-row">
          <div class="detail-icon">
            <i data-lucide="zap"></i>
          </div>
          <div class="detail-content">
            <span class="detail-label">Approved Load</span>
            <span class="detail-value {{#unless approved_load_kw}}placeholder{{/unless}}">
              {{#if approved_load_kw}}{{approved_load_kw}} kW{{else}}Not specified{{/if}}
            </span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-icon">
            <i data-lucide="activity"></i>
          </div>
          <div class="detail-content">
            <span class="detail-label">Phase</span>
            <span class="detail-value {{#unless approved_phase}}placeholder{{/unless}}">
              {{#if approved_phase}}{{approved_phase}}{{else}}Not specified{{/if}}
            </span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-icon">
            <i data-lucide="calendar"></i>
          </div>
          <div class="detail-content">
            <span class="detail-label">Registered</span>
            <span class="detail-value {{#unless registration_date}}placeholder{{/unless}}">
              {{#if registration_date}}{{formatDate registration_date}}{{else}}Unknown{{/if}}
            </span>
          </div>
        </div>
      </div>
      {{#if isInstalled}}
      <!-- Card Footer -->
      <div class="user-actions">
        <a href="/admin/user/{{id}}/latest" class="action-btn primary">
          <i data-lucide="eye"></i>
          <span>View Latest</span>
        </a>
        <a href="/admin/daily-summary/{{id}}" class="action-btn secondary">
          <i data-lucide="bar-chart-2"></i>
          <span>Daily Summary</span>
        </a>
      </div>
      {{else}}
      <!-- Installation Pending Section -->
      <div class="installation-pending">
        <div class="pending-header">
          <div class="pending-icon">
            <i data-lucide="clock"></i>
          </div>
          <div class="pending-text">
            <h4>Installation Pending</h4>
            <p>Meter installation is not yet completed for this consumer</p>
          </div>
        </div>

        <div class="installation-question">
          <span class="question-text">
            <i data-lucide="help-circle"></i>
            Installation completed?
          </span>
          <div class="installation-actions">
            <button class="install-btn confirm" data-user-id="{{id}}" onclick="markInstallationComplete(this)">
              <i data-lucide="check-circle"></i>
              <span>Yes</span>
            </button>
          </div>
        </div>
      </div>
      {{/if}}
    </div>
    {{/each}}
  </div>
  {{else}}
  <!-- Empty Users Array -->
  <div class="empty-state">
    <div class="empty-icon">
      <i data-lucide="users"></i>
    </div>
    <h3>No Users Registered Yet</h3>
    <p>Start by registering your first user to begin monitoring energy consumption.</p>

    <div class="empty-state-features">
      <div class="empty-state-feature">
        <div class="empty-state-feature-icon">
          <i data-lucide="user-plus"></i>
        </div>
        <div class="empty-state-feature-text">
          Register new users with their basic information
        </div>
      </div>

      <div class="empty-state-feature">
        <div class="empty-state-feature-icon">
          <i data-lucide="plug"></i>
        </div>
        <div class="empty-state-feature-text">
          Mark installation status when meters are deployed
        </div>
      </div>

      <div class="empty-state-feature">
        <div class="empty-state-feature-icon">
          <i data-lucide="activity"></i>
        </div>
        <div class="empty-state-feature-text">
          Monitor real-time energy consumption data
        </div>
      </div>
    </div>

    <div class="empty-state-actions">
      <a href="/admin/registration" class="empty-state-btn primary">
        <i data-lucide="user-plus"></i>
        <span>Register First User</span>
      </a>
      <a href="/admin/dashboard" class="empty-state-btn secondary">
        <i data-lucide="layout-dashboard"></i>
        <span>Back to Dashboard</span>
      </a>
    </div>
  </div>
  {{/if}}
  {{else}}
  <!-- No Users Data -->
  <div class="empty-state">
    <div class="empty-icon">
      <i data-lucide="database"></i>
    </div>
    <h3>Unable to Load Users</h3>
    <p>There was a problem loading the user data. This might be a temporary issue.</p>

    <div class="empty-state-actions">
      <button class="empty-state-btn primary" onclick="location.reload()">
        <i data-lucide="refresh-cw"></i>
        <span>Refresh Page</span>
      </button>
      <a href="/admin/dashboard" class="empty-state-btn secondary">
        <i data-lucide="layout-dashboard"></i>
        <span>Back to Dashboard</span>
      </a>
    </div>
  </div>
  {{/if}}
</div>

<script src="/js/admin-user.js"></script>